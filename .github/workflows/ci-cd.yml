name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  DOCKER_REGISTRY: ghcr.io
  BACKEND_IMAGE_NAME: kanlina/admin-backend-system-backend
  FRONTEND_IMAGE_NAME: kanlina/admin-backend-system-frontend

jobs:
  backend-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
      OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
      OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
      OSS_BUCKET_DOMAIN: ${{ secrets.OSS_BUCKET_DOMAIN }}
      OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Generate backend environment file
        working-directory: backend
        run: |
          cat <<ENV > .env
          OSS_ACCESS_KEY_ID=${OSS_ACCESS_KEY_ID}
          OSS_ACCESS_KEY_SECRET=${OSS_ACCESS_KEY_SECRET}
          OSS_BUCKET=${OSS_BUCKET}
          OSS_BUCKET_DOMAIN=${OSS_BUCKET_DOMAIN}
          OSS_ENDPOINT=${OSS_ENDPOINT}
          ENV

      - name: Run backend tests
        working-directory: backend
        run: npm run test --if-present

      - name: Build backend
        working-directory: backend
        run: npm run build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract backend metadata
        id: backend-meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}
          tags: |
            type=raw,value={{branch}}-sha{{sha7}},enable=${{ github.event_name == 'push' && github.ref_type == 'branch' }}
            type=raw,value={{branch}},enable=${{ github.event_name == 'push' && github.ref_type == 'branch' }}
            type=raw,value=sha{{sha7}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push backend Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: ${{ steps.backend-meta.outputs.tags }}
          labels: ${{ steps.backend-meta.outputs.labels }}

  frontend-build:
    runs-on: ubuntu-latest
    needs: backend-build
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Run frontend tests
        working-directory: frontend
        run: npm run test --if-present

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract frontend metadata
        id: frontend-meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}
          tags: |
            type=raw,value={{branch}}-sha{{sha7}},enable=${{ github.event_name == 'push' && github.ref_type == 'branch' }}
            type=raw,value={{branch}},enable=${{ github.event_name == 'push' && github.ref_type == 'branch' }}
            type=raw,value=sha{{sha7}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push frontend Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: ${{ steps.frontend-meta.outputs.tags }}
          labels: ${{ steps.frontend-meta.outputs.labels }}

  deploy-dev:
    needs: [backend-build, frontend-build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    env:
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_USERNAME: ${{ secrets.DEPLOY_USERNAME }}
      DEPLOY_PASSWORD: ${{ secrets.DEPLOY_PASSWORD }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
      OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
      OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
      OSS_BUCKET_DOMAIN: ${{ secrets.OSS_BUCKET_DOMAIN }}
      OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
    steps:
      - name: Deploy to development server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.DEPLOY_HOST }}
          username: ${{ env.DEPLOY_USERNAME }}
          password: ${{ env.DEPLOY_PASSWORD }}
          envs: GHCR_TOKEN,OSS_ACCESS_KEY_ID,OSS_ACCESS_KEY_SECRET,OSS_BUCKET,OSS_BUCKET_DOMAIN,OSS_ENDPOINT
          script: |
            set -e
            cd /www/wwwroot/admin-backend-system

            cat <<ENV > .env
            OSS_ACCESS_KEY_ID=${OSS_ACCESS_KEY_ID}
            OSS_ACCESS_KEY_SECRET=${OSS_ACCESS_KEY_SECRET}
            OSS_BUCKET=${OSS_BUCKET}
            OSS_BUCKET_DOMAIN=${OSS_BUCKET_DOMAIN}
            OSS_ENDPOINT=${OSS_ENDPOINT}
            ENV

            echo "=== Deploying Admin Backend System to Development ==="
            mkdir -p /var/log/admin-backend-dev /var/uploads/admin-backend-dev /var/app-logs/admin-backend-dev
            chmod 755 /var/log/admin-backend-dev /var/uploads/admin-backend-dev /var/app-logs/admin-backend-dev
            chown -R root:root /var/log/admin-backend-dev /var/uploads/admin-backend-dev /var/app-logs/admin-backend-dev

            if [ ! -d ".git" ]; then
              git clone https://github.com/kanlina/admin-backend-system.git .
            else
              git fetch origin
              git reset --hard origin/develop
              git clean -fd
            fi

            if [ -z "$GHCR_TOKEN" ]; then
              echo "Missing GHCR_TOKEN"
              exit 1
            fi

            echo "$GHCR_TOKEN" | docker login ghcr.io -u kanlina --password-stdin

            docker pull ghcr.io/kanlina/admin-backend-system-backend:develop
            docker pull ghcr.io/kanlina/admin-backend-system-frontend:develop

            docker compose -f docker-compose.dev.yml down || true
            docker compose -f docker-compose.dev.yml up -d

            sleep 60

            for i in {1..5}; do
              if curl -f http://localhost:3001/health; then
                break
              else
                if [ $i -eq 5 ]; then
                  docker logs admin-backend-api-dev --tail 50
                  exit 1
                fi
                sleep 30
              fi
            done

            for i in {1..3}; do
              if curl -f http://localhost:3000; then
                break
              else
                if [ $i -eq 3 ]; then
                  docker logs admin-backend-web-dev --tail 50
                  exit 1
                fi
                sleep 15
              fi
            done

  deploy-prod:
    needs: [backend-build, frontend-build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    env:
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_USERNAME: ${{ secrets.DEPLOY_USERNAME }}
      DEPLOY_PASSWORD: ${{ secrets.DEPLOY_PASSWORD }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
      OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
      OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
      OSS_BUCKET_DOMAIN: ${{ secrets.OSS_BUCKET_DOMAIN }}
      OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
    steps:
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.DEPLOY_HOST }}
          username: ${{ env.DEPLOY_USERNAME }}
          password: ${{ env.DEPLOY_PASSWORD }}
          envs: GHCR_TOKEN,OSS_ACCESS_KEY_ID,OSS_ACCESS_KEY_SECRET,OSS_BUCKET,OSS_BUCKET_DOMAIN,OSS_ENDPOINT
          script: |
            set -e
            cd /www/wwwroot/admin-backend-system

            cat <<ENV > .env
            OSS_ACCESS_KEY_ID=${OSS_ACCESS_KEY_ID}
            OSS_ACCESS_KEY_SECRET=${OSS_ACCESS_KEY_SECRET}
            OSS_BUCKET=${OSS_BUCKET}
            OSS_BUCKET_DOMAIN=${OSS_BUCKET_DOMAIN}
            OSS_ENDPOINT=${OSS_ENDPOINT}
            ENV

            echo "=== Deploying Admin Backend System to Production ==="
            mkdir -p /var/log/admin-backend-prod /var/uploads/admin-backend-prod /var/app-logs/admin-backend-prod
            chmod 755 /var/log/admin-backend-prod /var/uploads/admin-backend-prod /var/app-logs/admin-backend-prod
            chown -R root:root /var/log/admin-backend-prod /var/uploads/admin-backend-prod /var/app-logs/admin-backend-prod

            if [ ! -d ".git" ]; then
              git clone https://github.com/kanlina/admin-backend-system.git .
            else
              git fetch origin
              git reset --hard origin/main
              git clean -fd
            fi

            if [ -z "$GHCR_TOKEN" ]; then
              echo "Missing GHCR_TOKEN"
              exit 1
            fi

            echo "$GHCR_TOKEN" | docker login ghcr.io -u kanlina --password-stdin

            docker pull ghcr.io/kanlina/admin-backend-system-backend:main
            docker pull ghcr.io/kanlina/admin-backend-system-frontend:main

            docker compose -f docker-compose.prod.yml down || true
            docker compose -f docker-compose.prod.yml up -d

            sleep 60

            for i in {1..5}; do
              if curl -f http://localhost:3001/health; then
                break
              else
                if [ $i -eq 5 ]; then
                  docker logs admin-backend-api-prod --tail 50
                  exit 1
                fi
                sleep 30
              fi
            done

            for i in {1..3}; do
              if curl -f http://localhost:3000; then
                break
              else
                if [ $i -eq 3 ]; then
                  docker logs admin-backend-web-prod --tail 50
                  exit 1
                fi
                sleep 15
              fi
            done

